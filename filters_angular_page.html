<!DOCTYPE html>
<html ng-app="myApp">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>My AngularJS App</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet"
          type="text/css"/>
    <script src="//cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.20/angular.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script data-require="angular.js@*" data-semver="1.2.0-rc3-nonmin"
            src="http://code.angularjs.org/1.2.0-rc.3/angular.js"></script>
    <script>
        var myApp = angular.module('myApp', []);

        myApp.factory('listEdit', function() {
            var list1 = [],
                    maxLength = 5,
                    minLength = 1;

            return {
                add: function(item) {
                    if( list1.length >= maxLength )
                        return 'Too many list items';
                    list1.push(item);
                    return item + ' is added';
                },

                linkList: function(list){
                    list1 = list;
                }
            };
        });



        myApp.controller('SampleController', ['$scope', '$http', '$filter', 'listEdit', function ($scope, $http, $filter, listEdit) {
            $http.get('http://isa-api.herokuapp.com/transport/lines.json').then(function (res) {
                $scope.lines = res.data;
                $http.get('http://isa-api.herokuapp.com/transport/stops.json').then(function (res1) {
                    $scope.stops = res1.data;
                });
            });

            $scope.$watch('stopsFilter.stops', function () {
                if ($scope.stopsFilter) {
                    var filteredLines = $filter('filter')($scope.lines, $scope.stopsFilter);

                    $scope.filteredLines = [];
                    filteredLines.forEach(function (line) {

                        var indexOfSelectedStop;
                        line.stops.forEach(function (stop) {
                            if (stop.id == $scope.stopsFilter.stops) {
                                indexOfSelectedStop = line.stops.indexOf(stop);
                            }
                        });

                        console.log(indexOfSelectedStop);

                        var seconds = 0;
                        for (var i = 0; i <= indexOfSelectedStop; i++) {
                            seconds += line.dTimes[i];
                        }

                        console.log('sumaryczny czas', seconds);

//                        var hoursToAdd = seconds departure.hour;
//                        var minutesToAdd = departure.minutes + dTimes / 60;
//                        var secondsToAdd = departure.seconds + dTimes % 60;


//                            var seconds = 9999;
// multiply by 1000 because Date() requires miliseconds
                            var date = new Date(seconds * 1000);
                            var hh = date.getUTCHours();
                            var mm = date.getUTCMinutes();
                            var ss = date.getSeconds();
// If you were building a timestamp instead of a duration, you would uncomment the following line to get 12-hour (not 24) time
// if (hh > 12) {hh = hh % 12;}
// These lines ensure you have two-digits
                            if (hh < 10) {hh = "0"+hh;}
                            if (mm < 10) {mm = "0"+mm;}
                            if (ss < 10) {ss = "0"+ss;}
// This formats your string to HH:MM:SS
                            var t = hh+":"+mm+":"+ss;

                            console.log(t);
                            console.log(ss);

                        var departures = [];
                        line.departures.forEach(function (departure) {
                            departures.push({
                                hours: parseInt(departure.hour) + parseInt(hh),
                                minutes: parseInt(departure.minutes) + parseInt(mm),
                                seconds: parseInt(departure.seconds) + parseInt(ss)
                            });
                        });

                        var line = {
                            firstStop: line.stops[0].name,
                            lastStop: line.stops[line.stops.length - 1].name,
                            lineNo: line.name,
                            departures: departures
                        };


                         $scope.filteredLines.push(line);



                        localStorage.setItem("saved", JSON.stringify($scope.filteredLines));
                        var asString = localStorage.getItem("saved");
                        var obj = JSON.parse(asString);
                        console.log(line);

                    });



                    $scope.list = [];
                    listEdit.linkList( $scope.list );

                    $scope.addToList = function() {
                        $scope.feedback = listEdit.add($scope.todo);
                    };

                    $scope.remove = function(index) {
                        $scope.feedback =  listEdit.remove(index);
                    };

                }




            });

//            myApp.factory('listEdit', function() {
//                var list1 = [],
//                        maxLength = 5,
//                        minLength = 1;
//
//                return {
//                    add: function(item) {
//                        if( list1.length >= maxLength )
//                            return 'Too many list items';
//                        list1.push(item);
//                        return item + ' is added';
//                    },
//
//                    linkList: function(list){
//                        list1 = list;
//                    }
//                };
//            });
//
////Controller methods
//            myApp.controller('main', ['$scope', 'listEdit', function($scope, listEdit) {
//
//                $scope.list = [];
//                listEdit.linkList( $scope.list );
//
//                $scope.addToList = function() {
//                    $scope.feedback = listEdit.add($scope.todo);
//                };
//
//                $scope.remove = function(index) {
//                    $scope.feedback =  listEdit.remove(index);
//                };
//
//            }]);





        }]);
    </script>



</head>
<div ng-controller="SampleController">
    <br/>

    <div class="col-md-8 col-md-offset-2">
        <form class="form-horizontal" role="form">
            <div class="form-group">
                <label for="input2" class="col-sm-4 control-label">Wybierz przystanek</label>

                <div class="col-sm-6">
                    <select id="input2" class="form-control" ng-model="stopsFilter.stops ">
                            <option value="">Przystanki</option>
                            <option ng-repeat="item in stops" value="{{item.id}}">{{item.name}}</option>

                    </select>
                    <button ng-click ="addBusStop()">Add Item</button>
                    <div ng-repeat="todo in myApp track by $index">
                        <span ng-click="remove($index)">{{todo}}</span>
                    </div>
                </div>

            </div>
        </form>
        <h3>Lista autobusów</h3>
        <table class="table table-striped table-bordered">
            <thead>
            <tr>
                <th>#</th>
                <th>Przystanek</th>
                <th>Nr linii</th>
                <th>Przystanek końcowy</th>
                <th>Godziny odjazdu</th>
            </tr>
            </thead>
            <tbody>
            <tr ng-repeat="line in filteredLines">
                <td>{{$index + 1}}</td>
                <td>{{line.firstStop|uppercase }}</td>
                <td>{{ line.lineNo }}</td>
                <td>{{ line.lastStop|uppercase}}</td>
                <td>
                    <span ng-repeat="departure in line.departures">
                        {{departure.hours}}:{{departure.minutes}}:{{departure.seconds}},
                    </span>
                </td>
            </tr>
            <div>{{feedback}}&nbsp;</div>
            <select  ng-model="todo">
                <option value="">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
            </select>
            <button ng-click="addToList()">Add to List</button>
            <div ng-repeat="todo in list track by $index">
                <span ng-click="remove($index)">{{todo}}</span>
            </div>


            </tbody>
        </table>

    </div>
</div>
</body>


</html>